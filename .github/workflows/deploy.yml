name: Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      DEPLOY_HOST: ${{ secrets.SSH_HOST }}
      DEPLOY_USER: ${{ secrets.SSH_USER }}
      DEPLOY_PORT: ${{ secrets.SSH_PORT }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Sanity check repo contents (prevents --delete disasters)
        run: |
          ls -la
          test -f package.json || (echo "ERROR: Missing package.json in repo root" && exit 1)
          # test -d server || (echo "ERROR: Missing server/ folder" && exit 1)
          # test -f server/package.json || (echo "ERROR: Missing server/package.json" && exit 1)
          # test -d client || (echo "ERROR: Missing client/ folder" && exit 1)
          # test -f client/package.json || (echo "ERROR: Missing client/package.json" && exit 1)

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          cat > ~/.ssh/id_ed25519 <<'EOF'
          ${{ secrets.SSH_PRIVATE_KEY }}
          EOF
          chmod 600 ~/.ssh/id_ed25519
          ssh-keygen -y -f ~/.ssh/id_ed25519 >/dev/null
          PORT="${DEPLOY_PORT:-22}"
          echo "DEPLOY_HOST=[$DEPLOY_HOST]"
          echo "DEPLOY_PORT=[$DEPLOY_PORT]"
          getent hosts "$DEPLOY_HOST" || true
          nslookup "$DEPLOY_HOST" || true
          ssh-keyscan -p "$PORT" -H "$DEPLOY_HOST" >> ~/.ssh/known_hosts

      - name: Rsync to server
        run: |
          PORT="${DEPLOY_PORT:-22}"
          rsync -az --delete \
            --exclude ".git/" \
            --exclude ".env" \
            --exclude "ecosystem.config.cjs" \
            --exclude "/node_modules/" \
            -e "ssh -p $PORT" \
            ./ $DEPLOY_USER@$DEPLOY_HOST:/var/www/bracketmasterweb/

      - name: Run deploy script on server
        run: |
          PORT="${DEPLOY_PORT:-22}"
          ssh -p "$PORT" $DEPLOY_USER@$DEPLOY_HOST "bash /usr/local/bin/bracketmasterweb-deploy.sh"